<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¦–çˆ¾è¡Œç¨‹å°èˆªåŠ©æ‰‹ v6.4 (åœ°å€ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-google { background-color: #4285F4; color: white; }
        .btn-naver { background-color: #03C75A; color: white; }
        select { -webkit-appearance: none; }
        .modal-content::-webkit-scrollbar { width: 4px; }
        .modal-content::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // é è¨­åœ°é»æ•¸æ“šåº« (å·²æ›´æ–°è‡³ v6.2)
        const defaultLocations = [
            // --- åŸæœ‰åœ°é» ---
            { id: 1, name: "æ˜æ´å¤§ä½¿é¤¨æ›éŒ¢æ‰€", krName: "ëŒ€ì‚¬ê´€ì•í™˜ì „", lat: 37.5635, lng: 126.9837, desc: "æ˜æ´2è¡—105è™Ÿ" },
            { id: 2, name: "å¼˜å¤§-æ©¡å­æ¼«ç•« (Acorn Comics)", krName: "ë„í† ë¦¬ìºë¦¬ì»¤ì³", lat: 37.5614, lng: 126.9255, desc: "å»¶å—æ´æœ¬åº—" },
            { id: 3, name: "å¼˜å¤§-SPAO", krName: "ìŠ¤íŒŒì˜¤ í™ëŒ€", lat: 37.5559, lng: 126.9238, desc: "å¼˜å¤§9è™Ÿå‡ºå£é™„è¿‘" },
            { id: 4, name: "å¼˜å¤§-TOP TEN", krName: "íƒ‘í… í™ëŒ€", lat: 37.5558, lng: 126.9239, desc: "å¼˜å¤§9è™Ÿå‡ºå£é™„è¿‘" },
            { id: 5, name: "å¼˜å¤§-MLB", krName: "MLB í™ëŒ€", lat: 37.5560, lng: 126.9237, desc: "å¼˜å¤§9è™Ÿå‡ºå£é™„è¿‘" },
            { id: 6, name: "å¼˜å¤§-å–„è‰¯çš„çš®é‹", krName: "ì°©í•œêµ¬ë‘ í™ëŒ€", lat: 37.5563, lng: 126.9272, desc: "å¼˜å¤§8è™Ÿå‡ºå£æ­¥è¡Œ10åˆ†" },
            { id: 7, name: "å¼˜å¤§-å¤§å‰µ (Daiso)", krName: "ë‹¤ì´ì†Œ í™ëŒ€2í˜¸ì ", lat: 37.5574, lng: 126.9258, desc: "4è™Ÿå‡ºå£å¤§æ¨“" },
            { id: 8, name: "å¼˜å¤§-Nyunyu", krName: "ë‰´ë‰´ í™ëŒ€", lat: 37.5532, lng: 126.9213, desc: "é£¾å“åº—" },
            { id: 9, name: "å¼˜å¤§-å¼˜ç›Šè—¥å±€", krName: "í™ìµì•½êµ­", lat: 37.5572, lng: 126.9244, desc: "8è™Ÿå‡ºå£æ­¥è¡Œ1åˆ†" },
            { id: 10, name: "å¼˜å¤§-HDEXæ——è‰¦åº—", krName: "ì—ì´ì¹˜ë±ìŠ¤", lat: 37.5505, lng: 126.9217, desc: "å¥èº«æœé£¾" },
            { id: 11, name: "å¼˜å¤§-Olive Young (éŠæ¨‚å ´åº—)", krName: "ì˜¬ë¦¬ë¸Œì˜ í™ëŒ€ë†€ì´í„°ì ", lat: 37.5528, lng: 126.9235, desc: "HEDXéŠæ¨‚å ´åˆ†åº—æ—" },
            { id: 12, name: "å¼˜å¤§å¥³äººè¡—", krName: "í™ëŒ€ ê±·ê³ ì‹¶ì€ê±°ë¦¬", lat: 37.5568, lng: 126.9246, desc: "8è™Ÿå‡ºå£é™„è¿‘" },
            { id: 13, name: "AK PLAZA å¼˜å¤§", krName: "AKí”Œë¼ì í™ëŒ€", lat: 37.5574, lng: 126.9259, desc: "4è™Ÿå‡ºå£" },
            // æ›´æ–°èˆŠè³‡æ–™ (ID 14)
            { id: 14, name: "å¼˜å¤§ç¾é£Ÿ-è±šå£½ç™¾è±¬è‚‰æ¹¯é£¯", krName: "ëˆìˆ˜ë°± í™ëŒ€ì§ì˜ì ", lat: 37.5559, lng: 126.9232, desc: "24å°æ™‚ç‡Ÿæ¥­ (å¼˜ç›Šè·¯6è¡—74)" },
            { id: 15, name: "å¼˜å¤§-è‡ªç„¶é“é¹½éºµåŒ…", krName: "ìì—°ë„ì†Œê¸ˆë¹µ", lat: 37.5583, lng: 126.9242, desc: "2è™Ÿå‡ºå£é™„è¿‘" },
            { id: 16, name: "å»¶å—æ´-JUUNEEDU (ç¡è¡£)", krName: "ì¥¬ë‹ˆì¥¬", lat: 37.5618, lng: 126.9268, desc: "å»¶å—æ´" },
            
            // --- æ–°å¢åœ°é» ---
            { id: 17, name: "å»¶å—æ´-Hippo Brunch House", krName: "íˆí¬ ë¸ŒëŸ°ì¹˜í•˜ìš°ìŠ¤", lat: 37.56437, lng: 126.92535, desc: "09:00-21:30 (è–ç¾å±±è·¯17è¡—85)" },
            { id: 18, name: "å»¶ç¦§æ´-Grain Seoul", krName: "ê·¸ë ˆì¸ ì„œìš¸", lat: 37.56847, lng: 126.93045, desc: "æ—©åˆé¤ 09:00-17:30 (å»¶ç¦§è·¯11Gaè¡—53)" },
            { id: 19, name: "å¼˜å¤§-21ä¸–ç´€æˆ‘å€‘å¤§æµ·æ°´ç”¢", krName: "21ì„¸ê¸° ìš°ë¦¬ë°”ë‹¤ìˆ˜ì‚°", lat: 37.5566, lng: 126.9208, desc: "ç”Ÿé­šç‰‡/å¼˜å¤§1è™Ÿå‡ºå£ (æ±æ©‹æ´206-5)" },
            { id: 20, name: "æ˜æ´-å­è«‡åˆ€å‰Šéºµä¸€éš»é›", krName: "íš¨ë‹´ì¹¼êµ­ìˆ˜ ë‹­í•œë§ˆë¦¬", lat: 37.5627, lng: 126.9852, desc: "æ˜æ´ç¸½åº— B1 (æ˜æ´3è¡—12)" },
            { id: 21, name: "å¼˜å¤§-LOOF (è¡£æœåº—)", krName: "ë£¨í”„", lat: 37.5532, lng: 126.9223, desc: "å¼˜å¤§å•†åº—è¡— B1 (å¼˜ç›Šè·¯3è¡—20)" },
            { id: 22, name: "å»¶å—æ´-Heod æ—©åˆé¤", krName: "í•´ì˜« ì—°ë‚¨", lat: 37.5653, lng: 126.9247, desc: "11:00-21:00 (è–ç¾å±±è·¯29è¡—30)" }
        ];

        // å»¶é²å‡½å¼
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function App() {
            // Data Sources
            const [customLocs, setCustomLocs] = React.useState([]);
            const [sheetLocs, setSheetLocs] = React.useState([]);
            
            // Selection & Location
            const [startPoint, setStartPoint] = React.useState("current");
            const [endPoint, setEndPoint] = React.useState(defaultLocations[1].id); // é è¨­: æ©¡å­æ¼«ç•«
            const [userLocation, setUserLocation] = React.useState(null);
            const [locationError, setLocationError] = React.useState(null);
            
            // Modals
            const [showSettingsModal, setShowSettingsModal] = React.useState(false);
            const [showAddModal, setShowAddModal] = React.useState(false);

            // Sheet Settings State
            const [sheetUrl, setSheetUrl] = React.useState("");
            const [sheetStatus, setSheetStatus] = React.useState("idle"); 
            const [syncLog, setSyncLog] = React.useState("");
            const [syncProgress, setSyncProgress] = React.useState(0);

            // Manual Add Form State
            const [searchQuery, setSearchQuery] = React.useState(""); 
            const [newLocName, setNewLocName] = React.useState("");   
            const [newLocKrName, setNewLocKrName] = React.useState(""); 
            const [newLocNote, setNewLocNote] = React.useState("");
            const [newLocLat, setNewLocLat] = React.useState("");
            const [newLocLng, setNewLocLng] = React.useState("");
            const [isFetching, setIsFetching] = React.useState(false);

            const allLocations = [...defaultLocations, ...customLocs, ...sheetLocs];

            // Init
            React.useEffect(() => {
                const savedLocs = localStorage.getItem('myCustomLocations');
                if (savedLocs) try { setCustomLocs(JSON.parse(savedLocs)); } catch(e){}
                
                const savedSheetUrl = localStorage.getItem('googleSheetCsvUrl');
                if (savedSheetUrl) {
                    setSheetUrl(savedSheetUrl);
                    const cached = localStorage.getItem('cachedSheetLocs');
                    if (cached) {
                        setSheetLocs(JSON.parse(cached));
                        setSheetStatus("success");
                    } else fetchSheetData(savedSheetUrl);
                }
                getUserLocation();
            }, []);

            const getUserLocation = () => {
                if (!navigator.geolocation) { setLocationError("ä¸æ”¯æ´å®šä½"); return; }
                navigator.geolocation.getCurrentPosition(
                    (pos) => { setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }); setLocationError(null); },
                    (err) => setLocationError("ç„¡æ³•å®šä½")
                );
            };

            const handleDeleteLocation = (id) => {
                const targetId = Number(id);
                if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                    const updated = customLocs.filter(l => Number(l.id) !== targetId);
                    setCustomLocs(updated);
                    localStorage.setItem('myCustomLocations', JSON.stringify(updated));
                    if (startPoint == targetId) setStartPoint("current");
                    if (endPoint == targetId) setEndPoint(defaultLocations[0].id);
                }
            };

            // --- Address Cleaner (NEW) ---
            // ç§»é™¤éŸ“æ–‡åœ°å€ä¸­çš„æ‹¬è™Ÿå…§å®¹ã€æ¨“å±¤ã€è™Ÿç¢¼ï¼Œè®“ OSM æ›´å®¹æ˜“æœå°‹åˆ°
            const cleanAddress = (raw) => {
                let cleaned = raw;
                // ç§»é™¤æ‹¬è™ŸåŠå…§å®¹ (e.g., (í˜¸ê³„ë™))
                cleaned = cleaned.replace(/\([^)]*\)/g, '');
                // ç§»é™¤ B1, 1F, 2ì¸µ, 203í˜¸ ç­‰
                cleaned = cleaned.replace(/\s(B?\d+(F|ì¸µ|í˜¸))/gi, '');
                cleaned = cleaned.replace(/,\s*South Korea/i, ''); // æš«æ™‚ç§»é™¤åœ‹å®¶ï¼Œæœ€å¾Œæœå°‹å†è£œ
                return cleaned.trim();
            };

            // --- Basic Search (Nominatim only) ---
            const searchNominatim = async (query) => {
                try {
                    let optimizedQuery = query;
                    // å¦‚æœæ²’æœ‰åœ‹å®¶ï¼Œæ‰åŠ  South Korea (é¿å…é‡è¤‡)
                    if (!optimizedQuery.toLowerCase().includes("korea")) optimizedQuery += ", South Korea";
                    
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(optimizedQuery)}&limit=1&addressdetails=1`, {
                        headers: { 'Accept-Language': 'ko-KR,zh-TW,en;q=0.9' }
                    });
                    const data = await res.json();
                    
                    if (data && data.length > 0) {
                        return {
                            lat: parseFloat(data[0].lat),
                            lng: parseFloat(data[0].lon),
                            displayName: data[0].display_name
                        };
                    }
                } catch (e) {}
                return null;
            };

            // --- Manual Search Handler ---
            const handleSmartSearch = async () => {
                if (!searchQuery) return;
                setIsFetching(true);

                // 1. åº§æ¨™æ ¼å¼ Check
                const coordMatch = searchQuery.match(/(\d+\.\d+)\s*[,ï¼Œ]\s*(\d+\.\d+)/);
                if (coordMatch) {
                    setNewLocName("è‡ªè¨‚åº§æ¨™");
                    setNewLocLat(parseFloat(coordMatch[1]));
                    setNewLocLng(parseFloat(coordMatch[2]));
                    setNewLocKrName("Custom Location");
                    setNewLocNote("é€éåº§æ¨™æ–°å¢");
                    setIsFetching(false);
                    return;
                }

                // 2. OSM Search (Original)
                let osmResult = await searchNominatim(searchQuery);

                // 3. å¦‚æœå¤±æ•—ï¼Œå˜—è©¦ã€Œæ·¨åŒ–åœ°å€ã€å¾Œå†æœ
                if (!osmResult) {
                    const cleaned = cleanAddress(searchQuery);
                    if (cleaned !== searchQuery) {
                        // console.log("Retrying with cleaned address:", cleaned);
                        osmResult = await searchNominatim(cleaned);
                    }
                }

                if (osmResult) {
                    setNewLocName(searchQuery); // åç¨±ä¿ç•™åŸæœ¬è¼¸å…¥çš„å®Œæ•´å­—ä¸²
                    setNewLocLat(osmResult.lat);
                    setNewLocLng(osmResult.lng);
                    // å˜—è©¦åªå–ç¬¬ä¸€æ®µä½œç‚ºéŸ“æ–‡åç¨±ï¼Œé¿å…é¡¯ç¤ºå¤ªé•·åœ°å€
                    setNewLocKrName(osmResult.displayName.split(",")[0]); 
                    setNewLocNote("è‡ªå‹•æœå°‹çµæœ");
                } else {
                    alert("æ‰¾ä¸åˆ°æ­¤åœ°é»ã€‚åŸå› å¯èƒ½æ˜¯ OpenStreetMap è³‡æ–™åº«æ²’æœ‰è©²è©³ç´°åœ°å€ã€‚\n\nå»ºè­°ï¼š\n1. é»æ“Šä¸‹æ–¹ã€Naver Mapã€æŒ‰éˆ•\n2. åœ¨ Naver Map æ‰¾åˆ°åœ°é»å¾Œï¼Œé•·æŒ‰åœ°åœ–è¤‡è£½ã€åº§æ¨™ã€\n3. è²¼å›æ­¤è™•æœå°‹");
                }
                
                setIsFetching(false);
            };

            // --- Sheet Logic ---
            const parseCSV = (text) => {
                const rows = []; let row = []; let inQuote = false; let currentCell = "";
                for (let i = 0; i < text.length; i++) {
                    const char = text[i]; const nextChar = text[i+1];
                    if (char === '"') { if (inQuote && nextChar === '"') { currentCell += '"'; i++; } else { inQuote = !inQuote; } }
                    else if (char === ',' && !inQuote) { row.push(currentCell.trim()); currentCell = ""; }
                    else if ((char === '\r' || char === '\n') && !inQuote) {
                        if (currentCell || row.length > 0) row.push(currentCell.trim());
                        if (row.length > 0) rows.push(row);
                        row = []; currentCell = ""; if (char === '\r' && nextChar === '\n') i++;
                    } else { currentCell += char; }
                }
                if (currentCell || row.length > 0) row.push(currentCell.trim()); if (row.length > 0) rows.push(row);
                return rows;
            };

            const fetchSheetData = async (url) => {
                if (!url) return;
                setSheetStatus("loading");
                setSyncLog("è®€å–æ¸…å–®ä¸­...");
                setSyncProgress(0);
                
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const text = await res.text();
                    const rows = parseCSV(text);
                    const newSheetLocs = [];
                    const dataRows = rows.slice(1).filter(r => r.length >= 1 && r[0]); 
                    const total = dataRows.length;

                    for (let i = 0; i < total; i++) {
                        const col = dataRows[i];
                        const name = col[0];
                        const note = col[1] || "";
                        setSyncLog(`è§£æä¸­ (${i+1}/${total}): ${name}`);
                        setSyncProgress(Math.round(((i+1)/total)*100));

                        let lat = 0, lng = 0;
                        let autoInfo = false;
                        let krName = name;

                        const coordMatch = name.match(/(\d+\.\d+)\s*[,ï¼Œ]\s*(\d+\.\d+)/);
                        if (coordMatch) {
                            lat = parseFloat(coordMatch[1]);
                            lng = parseFloat(coordMatch[2]);
                        } else {
                            // åƒ…ä½¿ç”¨ OSM æœå°‹ï¼Œç„¡ AI
                            await delay(1100); 
                            // å˜—è©¦åŸå§‹æœå°‹
                            let osmRes = await searchNominatim(name);
                            // å˜—è©¦æ·¨åŒ–æœå°‹
                            if (!osmRes) {
                                const cleaned = cleanAddress(name);
                                if (cleaned !== name) osmRes = await searchNominatim(cleaned);
                            }

                            if (osmRes) { lat = osmRes.lat; lng = osmRes.lng; autoInfo = true; }
                        }

                        if (lat !== 0) {
                            newSheetLocs.push({
                                id: `sheet-${i}`, name: name, krName: krName,
                                desc: note || (autoInfo ? "è‡ªå‹•å®šä½" : "Sheet è³‡æ–™"),
                                lat: lat, lng: lng, isSheet: true, isAutoDetected: autoInfo
                            });
                        }
                    }

                    setSheetLocs(newSheetLocs);
                    localStorage.setItem('cachedSheetLocs', JSON.stringify(newSheetLocs));
                    localStorage.setItem('googleSheetCsvUrl', url);
                    setSheetStatus("success");
                    setSyncLog(`å®Œæˆï¼å…± ${newSheetLocs.length} ç­†`);
                } catch (error) {
                    setSheetStatus("error");
                    setSyncLog("å¤±æ•—ï¼š" + error.message);
                }
            };

            const handleAddLocation = () => {
                if (!newLocName || !newLocLat || !newLocLng) { alert("ç„¡æ•ˆçš„åœ°é»è³‡æ–™"); return; }
                const newLoc = {
                    id: Date.now(),
                    name: newLocName,
                    krName: newLocKrName || newLocName,
                    lat: parseFloat(newLocLat),
                    lng: parseFloat(newLocLng),
                    desc: newLocNote,
                    isCustom: true
                };
                const updated = [...customLocs, newLoc];
                setCustomLocs(updated);
                localStorage.setItem('myCustomLocations', JSON.stringify(updated));
                setSearchQuery(""); setNewLocName(""); setNewLocKrName(""); setNewLocNote(""); setNewLocLat(""); setNewLocLng(""); 
                setShowAddModal(false);
            };

            const getLocData = (id) => {
                if (id === "current") return userLocation ? { name: "æˆ‘çš„ç›®å‰ä½ç½®", krName: "ë‚´ ìœ„ì¹˜", lat: userLocation.lat, lng: userLocation.lng } : null;
                return allLocations.find(l => l.id == id);
            };

            const startLoc = getLocData(startPoint);
            const endLoc = getLocData(endPoint);
            
            let distanceDisplay = "---";
            if (startLoc && endLoc) {
                const R = 6371; 
                const dLat = (endLoc.lat - startLoc.lat) * Math.PI / 180;
                const dLon = (endLoc.lng - startLoc.lng) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(startLoc.lat * Math.PI / 180) * Math.cos(endLoc.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                distanceDisplay = (R * c).toFixed(2);
            }

            const playKorean = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ko-KR'; u.rate = 0.8;
                window.speechSynthesis.speak(u);
            };

            const openMap = (type) => {
                if (!startLoc || !endLoc) return;
                if (type === 'google') {
                    window.open(`https://www.google.com/maps/dir/?api=1&origin=${startLoc.lat},${startLoc.lng}&destination=${endLoc.lat},${endLoc.lng}&travelmode=transit`, '_blank');
                } else {
                    const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
                    if (isMobile) {
                        // ä½¿ç”¨ nmap Scheme å¼·åˆ¶é–‹å•Ÿ App ä¸¦å‚³éåº§æ¨™ (WGS84)
                        const url = `nmap://route/public?slat=${startLoc.lat}&slng=${startLoc.lng}&sname=${encodeURIComponent(startLoc.krName)}&dlat=${endLoc.lat}&dlng=${endLoc.lng}&dname=${encodeURIComponent(endLoc.krName)}&appname=seoul_trip_helper`;
                        window.location.href = url;
                    } else {
                        const url = `https://map.naver.com/p/directions/${startLoc.lng},${startLoc.lat},${encodeURIComponent(startLoc.krName)}/${endLoc.lng},${endLoc.lat},${encodeURIComponent(endLoc.krName)}/-/transit?c=15.00,0,0,0,dh`;
                        window.open(url, '_blank');
                    }
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-20 relative">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-white rounded-b-3xl shadow-lg mb-6 flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-bold mb-1">é¦–çˆ¾è¡Œç¨‹åŠ©æ‰‹</h1>
                            <p className="text-blue-100 text-sm opacity-90">v6.4 åœ°å€ä¿®æ­£ç‰ˆ</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSettingsModal(true)} className="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center transition relative">
                                <i className="fas fa-cog"></i>
                                {sheetStatus === 'success' && <span className="absolute top-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-indigo-700"></span>}
                                {sheetStatus === 'error' && <span className="absolute top-0 right-0 w-3 h-3 bg-red-400 rounded-full border-2 border-indigo-700"></span>}
                            </button>
                            <button onClick={() => setShowAddModal(true)} className="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <i className="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div className="px-4 space-y-4">
                        {/* Selector Card */}
                        <div className="card p-5 space-y-5">
                            <div className="relative">
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1 ml-1 flex justify-between">
                                    <span><i className="fas fa-map-marker-alt text-green-500 mr-1"></i> å‡ºç™¼åœ°</span>
                                    {startPoint === "current" && locationError && <span className="text-red-500 text-[10px]">{locationError}</span>}
                                </label>
                                <select value={startPoint} onChange={(e) => { setStartPoint(e.target.value); if(e.target.value==="current") getUserLocation(); }} className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                                    <option value="current">ğŸ“ æˆ‘çš„ç›®å‰ä½ç½® (GPS)</option>
                                    <optgroup label="é è¨­åœ°é»">{defaultLocations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</optgroup>
                                    {customLocs.length > 0 && <optgroup label="æˆ‘çš„è‡ªè¨‚åœ°é»">{customLocs.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</optgroup>}
                                    {sheetLocs.length > 0 && <optgroup label="Google Sheet åŒæ­¥">{sheetLocs.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</optgroup>}
                                </select>
                            </div>
                            <div className="flex items-center justify-center -my-2 relative z-10"><div className="bg-white p-2 rounded-full shadow-sm border border-gray-100"><i className="fas fa-arrow-down text-gray-300"></i></div></div>
                            <div className="relative">
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1 ml-1"><i className="fas fa-map-pin text-red-500 mr-1"></i> ç›®çš„åœ°</label>
                                <select value={endPoint} onChange={(e) => setEndPoint(e.target.value)} className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                                    <optgroup label="é è¨­åœ°é»">{defaultLocations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</optgroup>
                                    {customLocs.length > 0 && <optgroup label="æˆ‘çš„è‡ªè¨‚åœ°é»">{customLocs.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</optgroup>}
                                    {sheetLocs.length > 0 && <optgroup label="Google Sheet åŒæ­¥">{sheetLocs.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</optgroup>}
                                </select>
                            </div>
                        </div>

                        {/* Result */}
                        <div className="card p-6 text-center border-l-4 border-indigo-500">
                            <p className="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">ç›´ç·šè·é›¢ä¼°ç®—</p>
                            <div className="text-4xl font-extrabold text-gray-800 mb-1">{distanceDisplay} <span className="text-lg text-gray-500 font-medium">km</span></div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 pt-2">
                            <button onClick={() => openMap('google')} className="btn-google py-4 px-4 rounded-xl font-bold shadow-lg flex flex-col items-center justify-center gap-2"><i className="fab fa-google text-2xl"></i> <span>Google Map</span></button>
                            <button onClick={() => openMap('naver')} className="btn-naver py-4 px-4 rounded-xl font-bold shadow-lg flex flex-col items-center justify-center gap-2"><span className="text-2xl font-black">N</span> <span>Naver Map</span></button>
                        </div>

                        {/* Info */}
                        {endLoc && (
                        <div className="mt-6">
                            <h3 className="text-gray-500 font-bold text-sm ml-1 mb-2 flex justify-between">
                                <span><i className="fas fa-info-circle mr-2"></i>ç›®çš„åœ°è³‡è¨Š</span>
                                {endLoc.isCustom && <button type="button" onClick={() => handleDeleteLocation(endLoc.id)} className="text-xs text-red-400 underline hover:text-red-600">åˆªé™¤æ­¤åœ°é»</button>}
                            </h3>
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                <div className="flex flex-wrap gap-2 mb-2">
                                    <h4 className="font-bold text-gray-800 text-lg mr-2">{endLoc.name}</h4>
                                    {endLoc.isSheet && <span className="text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded-full self-center">Sheet</span>}
                                    {endLoc.isCustom && <span className="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded-full self-center">è‡ªè¨‚</span>}
                                    {endLoc.isAutoDetected && <span className="text-[10px] bg-yellow-100 text-yellow-600 px-2 py-1 rounded-full self-center">è‡ªå‹•å®šä½</span>}
                                </div>
                                <div className="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-100 mb-3">
                                    <div><span className="text-xs text-gray-400 block mb-1">éŸ“æ–‡åç¨± (ç”¨æ–¼å•è·¯)</span><span className="text-xl font-bold text-gray-800 font-sans">{endLoc.krName}</span></div>
                                    <button onClick={() => playKorean(endLoc.krName)} className="bg-blue-100 text-blue-700 p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-sm"><i className="fas fa-volume-up"></i></button>
                                </div>
                                <div className="rounded-lg border border-gray-200 overflow-hidden h-40">
                                    <iframe width="100%" height="100%" frameBorder="0" scrolling="no" src={`https://maps.google.com/maps?q=${endLoc.lat},${endLoc.lng}&z=16&output=embed`}></iframe>
                                </div>
                                <p className="text-gray-500 text-sm mt-3 pt-2 border-t">{endLoc.desc}</p>
                            </div>
                        </div>
                        )}
                    </div>

                    {/* Settings Modal (Sheet Only) */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl flex flex-col max-h-[90vh] relative modal-content">
                                <h2 className="text-xl font-bold mb-4 text-gray-800">è³‡æ–™åŒæ­¥è¨­å®š</h2>
                                <div className="space-y-4 overflow-y-auto px-1">
                                    <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                        <h3 className="font-bold text-green-800 text-sm mb-2"><i className="fas fa-file-csv mr-1"></i> Google Sheet åŒæ­¥</h3>
                                        <p className="text-xs text-green-700">åœ¨è©¦ç®—è¡¨è¼¸å…¥åœ°åï¼Œè®“ç¨‹å¼è‡ªå‹•æŠ“å–ã€‚</p>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-500 mb-1">CSV é€£çµ</label>
                                        <input type="text" value={sheetUrl} onChange={e => setSheetUrl(e.target.value)} placeholder="https://...output=csv" className="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none text-xs"/>
                                        <div className="mt-2 text-xs">ç‹€æ…‹: {sheetStatus} {syncProgress > 0 && `(${syncProgress}%)`}</div>
                                        {syncLog && <p className="text-[10px] text-gray-500 mt-1 truncate">{syncLog}</p>}
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button onClick={handleDeleteSettings} className="flex-1 py-3 text-red-400 font-medium hover:bg-red-50 rounded-xl text-sm">æ¸…é™¤</button>
                                        <button onClick={() => { fetchSheetData(sheetUrl); }} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg text-sm" disabled={sheetStatus === 'loading'}>
                                            {sheetStatus === 'loading' ? 'åŒæ­¥ä¸­...' : 'é–‹å§‹åŒæ­¥'}
                                        </button>
                                    </div>
                                    <button onClick={() => setShowSettingsModal(false)} className="w-full py-3 bg-gray-100 text-gray-600 font-bold rounded-xl text-sm hover:bg-gray-200">é—œé–‰</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add Location Modal */}
                    {showAddModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all flex flex-col max-h-[90vh]">
                                <h2 className="text-xl font-bold mb-4 text-gray-800 shrink-0">æ–°å¢åœ°é»</h2>
                                <div className="space-y-3 overflow-y-auto px-1">
                                    <div className="bg-indigo-50 p-4 rounded-xl border-2 border-dashed border-indigo-200">
                                        <label className="block text-xs font-bold text-indigo-500 mb-2 flex items-center gap-1">
                                            <i className="fas fa-search"></i> æœå°‹
                                        </label>
                                        <div className="flex gap-2 mb-2">
                                            <div className="relative flex-1">
                                                <input type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="è¼¸å…¥åœ°åã€åº§æ¨™æˆ–è¤‡é›œåœ°å€..." className="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"/>
                                                {isFetching && <div className="absolute right-2 top-2 text-indigo-500"><i className="fas fa-circle-notch fa-spin"></i></div>}
                                            </div>
                                            <button onClick={handleSmartSearch} className="bg-indigo-600 text-white px-3 rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-700 whitespace-nowrap">æœå°‹</button>
                                        </div>
                                        <div className="flex flex-col items-center pt-2 border-t border-indigo-200 space-y-2">
                                            <div className="flex justify-between items-center w-full">
                                                <span className="text-[10px] text-gray-500">æœä¸åˆ°ï¼Ÿ</span>
                                                <button onClick={() => searchQuery && window.open(`https://map.naver.com/p/search/${encodeURIComponent(searchQuery)}`, '_blank')} className="text-xs bg-green-500 text-white px-3 py-1 rounded-full font-bold hover:bg-green-600 transition flex items-center gap-1"><span className="font-black">N</span> Naver Map</button>
                                            </div>
                                            <div className="text-[10px] text-gray-500 bg-white/50 p-2 rounded w-full text-center">
                                                <i className="fas fa-info-circle mr-1"></i>
                                                é–‹å•Ÿ Naver Map å¾Œï¼Œè«‹è¤‡è£½ã€åœ°å€ã€æˆ–ã€åº§æ¨™ã€ï¼Œè²¼å›ä¸Šæ–¹æœå°‹æ¬„æŒ‰ã€æœå°‹ã€å³å¯ã€‚
                                            </div>
                                        </div>
                                    </div>

                                    <div className="opacity-80">
                                        <div><label className="block text-xs text-gray-500 mb-1">åç¨±</label><input type="text" value={newLocName} onChange={e => setNewLocName(e.target.value)} className="w-full p-3 border rounded-lg bg-gray-50 outline-none font-bold text-gray-800"/></div>
                                        <div><label className="block text-xs text-gray-500 mb-1">éŸ“æ–‡åç¨±</label><input type="text" value={newLocKrName} onChange={e => setNewLocKrName(e.target.value)} className="w-full p-3 border rounded-lg bg-gray-50 outline-none font-sans"/></div>
                                        <div><label className="block text-xs text-gray-500 mb-1">å‚™è¨»</label><input type="text" value={newLocNote} onChange={e => setNewLocNote(e.target.value)} className="w-full p-3 border rounded-lg bg-gray-50 outline-none"/></div>
                                    </div>
                                </div>
                                <div className="mt-6 flex gap-3 shrink-0">
                                    <button onClick={() => setShowAddModal(false)} className="flex-1 py-3 text-gray-500 font-medium hover:bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                                    <button onClick={handleAddLocation} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
